# Express + tsoa Integration Guide

This document explains how the Express API is integrated with MooseStack using tsoa for type-safe routing and automatic OpenAPI documentation generation.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Project Structure](#project-structure)
3. [How It Works](#how-it-works)
4. [Adding New Endpoints](#adding-new-endpoints)
5. [Working with MooseStack Utilities](#working-with-moosestack-utilities)
6. [API Documentation](#api-documentation)
7. [Development Workflow](#development-workflow)
8. [Troubleshooting](#troubleshooting)

---

## Architecture Overview

### What is tsoa?

[tsoa](https://tsoa-community.github.io/docs/) is a framework that uses TypeScript decorators to:
- Define API routes and controllers
- Automatically validate request/response data based on TypeScript types
- Generate OpenAPI (Swagger) specifications
- Generate Express routes from controller definitions

### Why tsoa?

✅ **Type Safety**: Compile-time type checking for API endpoints
✅ **Auto-validation**: Request validation without manual schema writing
✅ **Auto-documentation**: OpenAPI spec generated from code
✅ **Clean Code**: Declarative API definitions using decorators
✅ **No Runtime Dependencies**: Uses TypeScript types directly

### Integration with MooseStack

The Express app is integrated into MooseStack using the `WebApp` class, which:
- Mounts the Express app at a specific path (`/express`)
- Provides MooseStack utilities (ClickHouse client, SQL builder, JWT auth)
- Integrates with the Moose development environment

---

## Project Structure

```
debezium-cdc/
├── app/
│   ├── api.ts                          # Main Express app entry point
│   ├── controllers/                    # tsoa controllers
│   │   ├── HealthController.ts         # Health check endpoint
│   │   ├── QueryController.ts          # General query endpoints
│   │   ├── OltpController.ts           # PostgreSQL (OLTP) endpoints
│   │   └── OlapController.ts           # ClickHouse (OLAP) endpoints
│   ├── types/
│   │   └── api.ts                      # Shared API types
│   └── ...
├── .generated/                         # Auto-generated by tsoa (gitignored)
│   ├── routes.ts                       # Express routes
│   └── swagger.json                    # OpenAPI spec
├── tsoa.json                           # tsoa configuration
└── tsconfig.json                       # TypeScript configuration
```

### Key Files

| File | Purpose |
|------|---------|
| `app/api.ts` | Main Express app, middleware setup, WebApp export |
| `app/controllers/*.ts` | API endpoint definitions using tsoa decorators |
| `app/types/api.ts` | Shared TypeScript interfaces for API responses |
| `tsoa.json` | Configuration for route/spec generation |
| `.generated/routes.ts` | Auto-generated Express routes (don't edit!) |
| `.generated/swagger.json` | Auto-generated OpenAPI spec (don't edit!) |

---

## How It Works

### 1. Controller Definition

Controllers use tsoa decorators to define endpoints:

```typescript
import { Controller, Get, Route, Tags, Query, Path } from "tsoa";

@Route("oltp/customer-addresses")
@Tags("OLTP Customer Addresses")
export class OltpCustomerAddressesController extends Controller {
  /**
   * List all customer addresses from OLTP database
   * @param limit Maximum number of records to return
   * @param offset Number of records to skip
   */
  @Get()
  public async listCustomerAddresses(
    @Query() limit: number = 100,
    @Query() offset: number = 0
  ): Promise<PaginatedResponse<any>> {
    // Implementation here...
  }

  /**
   * Get a single customer address by ID
   * @param id Customer address ID
   */
  @Get("{id}")
  public async getCustomerAddress(
    @Path() id: number
  ): Promise<SingleResponse<any>> {
    // Implementation here...
  }
}
```

### 2. Route Generation

When you run `npm run tsoa:gen`, tsoa:
1. Scans all files matching `app/controllers/**/*.ts`
2. Reads the decorators and TypeScript types
3. Generates `.generated/routes.ts` with Express route handlers
4. Generates `.generated/swagger.json` with OpenAPI spec

### 3. Express App Setup

The Express app (`app/api.ts`) follows this middleware chain:

```typescript
// 1. CORS - Enable cross-origin requests
app.use(cors());

// 2. Body parsers - Parse JSON and URL-encoded bodies
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 3. MooseStack middleware - Add Moose utilities to req object
app.use(expressMiddleware());

// 4. Logging - Log all requests
app.use((req, res, next) => { console.log(...); next(); });

// 5. Swagger UI - Serve API documentation
app.use("/docs", swaggerUi.serve, swaggerUi.setup(...));

// 6. tsoa routes - Register all API endpoints
RegisterRoutes(app);

// 7. Error handler - Catch and handle errors
app.use((err, req, res, next) => { ... });
```

### 4. MooseStack Integration

The app is exported as a `WebApp`:

```typescript
export const exampleExpressApi = new WebApp("exampleExpress", app, {
  mountPath: "/express",
  metadata: {
    description: "Express API with tsoa demonstrating WebApp integration",
  },
});
```

This mounts the entire Express app at `http://localhost:4000/express/`.

---

## Adding New Endpoints

### Step 1: Create a Controller

Create a new file in `app/controllers/`:

```typescript
// app/controllers/MyController.ts
import { Controller, Get, Post, Route, Tags, Body, Path } from "tsoa";

interface CreateItemRequest {
  name: string;
  description: string;
}

interface ItemResponse {
  id: number;
  name: string;
  description: string;
  createdAt: string;
}

@Route("items")
@Tags("Items")
export class ItemsController extends Controller {
  /**
   * List all items
   */
  @Get()
  public async listItems(): Promise<ItemResponse[]> {
    // Your implementation
    return [];
  }

  /**
   * Create a new item
   */
  @Post()
  public async createItem(
    @Body() body: CreateItemRequest
  ): Promise<ItemResponse> {
    // Your implementation
    this.setStatus(201); // Set HTTP status code
    return {
      id: 1,
      name: body.name,
      description: body.description,
      createdAt: new Date().toISOString(),
    };
  }

  /**
   * Get item by ID
   */
  @Get("{id}")
  public async getItem(@Path() id: number): Promise<ItemResponse> {
    // Your implementation
    if (!found) {
      this.setStatus(404);
      throw new Error("Item not found");
    }
    return item;
  }
}
```

### Step 2: Regenerate Routes

```bash
npm run tsoa:gen
```

This updates `.generated/routes.ts` and `.generated/swagger.json`.

### Step 3: Test Your Endpoint

```bash
# Start the dev server
npm run dev

# Test with curl
curl http://localhost:4000/express/items

# Or view in Swagger UI
open http://localhost:4000/express/docs
```

---

## Working with MooseStack Utilities

### Accessing MooseStack in Controllers

Use `@Request()` decorator to access the Express request object:

```typescript
import { Controller, Get, Request } from "tsoa";
import { Request as ExpressRequest } from "express";
import { getMooseUtils } from "@514labs/moose-lib";

@Route("data")
export class DataController extends Controller {
  @Get("query")
  public async queryData(
    @Request() request: ExpressRequest
  ): Promise<any> {
    // Get MooseStack utilities
    const moose = getMooseUtils(request);

    if (!moose) {
      this.setStatus(500);
      throw new Error("MooseStack utilities not available");
    }

    // Access ClickHouse client
    const { client, sql } = moose;

    // Build and execute query
    const query = sql`
      SELECT * FROM my_table
      LIMIT 10
    `;

    const result = await client.query.execute(query);
    const data = await result.json();

    return { success: true, data };
  }
}
```

### Available MooseStack Utilities

| Utility | Description |
|---------|-------------|
| `moose.client` | ClickHouse client for OLAP queries |
| `moose.sql` | SQL template tag for safe query building |
| `moose.jwt` | Decoded JWT token (if authenticated) |

---

## API Documentation

### Viewing the Swagger UI

Open: `http://localhost:4000/express/docs`

Features:
- Interactive API explorer
- Request/response schemas
- "Try it out" functionality
- Authentication support

### OpenAPI Spec

The raw OpenAPI specification is available at:
- **JSON**: `.generated/swagger.json`
- **URL**: `http://localhost:4000/express/api-spec`

### Documentation Best Practices

1. **Add JSDoc comments** to controller methods:
   ```typescript
   /**
    * Retrieve all customer addresses with pagination
    *
    * @param limit Maximum number of records to return (default: 100)
    * @param offset Number of records to skip for pagination (default: 0)
    * @returns Paginated list of customer addresses
    */
   @Get()
   public async listCustomerAddresses(...) { }
   ```

2. **Use descriptive parameter names**:
   ```typescript
   @Query() limit: number = 100        // Good
   @Query() l: number = 100            // Bad
   ```

3. **Define response types**:
   ```typescript
   interface CustomerAddress {
     id: number;
     street: string;
     city: string;
     state: string;
     zipCode: string;
   }

   @Get("{id}")
   public async getCustomerAddress(
     @Path() id: number
   ): Promise<CustomerAddress> { }  // Type appears in docs!
   ```

---

## Development Workflow

### Daily Development

1. **Start the dev server**:
   ```bash
   npm run dev
   ```
   The server watches for file changes and auto-restarts.

2. **Make changes** to controllers in `app/controllers/`

3. **Regenerate routes** (if you changed controller signatures):
   ```bash
   npm run tsoa:gen
   ```
   Note: The `.generated` folder is outside `/app` to prevent infinite reload loops.

4. **Test your changes**:
   - Use Swagger UI: `http://localhost:4000/express/docs`
   - Use curl or Postman
   - Write tests

### Build for Production

```bash
npm run build
```

This runs `npm run tsoa:gen` then builds a Docker image.

### Available Scripts

| Script | Purpose |
|--------|---------|
| `npm run dev` | Start dev server with hot reload |
| `npm run build` | Generate routes + build Docker image |
| `npm run tsoa:gen` | Generate routes and OpenAPI spec |
| `npm run tsoa:spec` | Generate only OpenAPI spec |
| `npm run tsoa:routes` | Generate only routes |

---

## Troubleshooting

### Issue: "Failed to fetch" in Swagger UI

**Cause**: CORS or incorrect spec URL

**Solution**:
1. Verify CORS is enabled in `app/api.ts`
2. Check that `/api-spec` endpoint is accessible
3. Ensure Swagger UI points to `/express/api-spec`

### Issue: Endpoint not found (404)

**Cause**: Routes not regenerated after controller changes

**Solution**:
```bash
npm run tsoa:gen
```

### Issue: Validation errors on valid requests

**Cause**: TypeScript types don't match request format

**Solution**:
1. Check your interface definitions
2. Ensure decorators match request structure:
   - `@Query()` for query parameters
   - `@Body()` for request body
   - `@Path()` for URL parameters
3. Check the generated `swagger.json` to see expected format

### Issue: Infinite reload loop

**Cause**: `.generated` folder is being watched by file watcher

**Solution**: The `.generated` folder is already configured outside `/app` directory and excluded in `tsconfig.json`. If you still experience issues, verify:
- `.generated` is in `.gitignore`
- `.generated` is in `tsconfig.json` exclude list

### Issue: MooseStack utilities not available

**Cause**: Middleware order is incorrect

**Solution**: Ensure `expressMiddleware()` is called **before** `RegisterRoutes(app)` in `app/api.ts`.

### Issue: TypeScript compilation errors

**Cause**: Missing tsoa decorators configuration

**Solution**: Verify `tsconfig.json` has:
```json
{
  "compilerOptions": {
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  }
}
```

---

## Additional Resources

### tsoa Documentation
- **Official Docs**: https://tsoa-community.github.io/docs/
- **Decorators Reference**: https://tsoa-community.github.io/docs/decorators.html
- **GitHub**: https://github.com/lukeautry/tsoa

### OpenAPI/Swagger
- **OpenAPI Spec**: https://swagger.io/specification/
- **Swagger UI**: https://swagger.io/tools/swagger-ui/

### MooseStack
- **MooseStack Docs**: Check internal documentation for `WebApp` and `expressMiddleware`

---

## Code Examples

### Example 1: Simple GET Endpoint

```typescript
@Route("health")
@Tags("Health")
export class HealthController extends Controller {
  @Get()
  public async getHealth(): Promise<{ status: string }> {
    return { status: "ok" };
  }
}
```

**Access**: `GET http://localhost:4000/express/health`

### Example 2: POST with Body Validation

```typescript
interface CreateUserRequest {
  email: string;
  name: string;
  age?: number;
}

@Route("users")
@Tags("Users")
export class UsersController extends Controller {
  @Post()
  public async createUser(
    @Body() body: CreateUserRequest
  ): Promise<{ id: string; email: string }> {
    // tsoa automatically validates:
    // - email is a string (required)
    // - name is a string (required)
    // - age is a number or undefined (optional)

    this.setStatus(201);
    return {
      id: "123",
      email: body.email,
    };
  }
}
```

**Access**: `POST http://localhost:4000/express/users`

### Example 3: Query Parameters with Defaults

```typescript
@Route("search")
@Tags("Search")
export class SearchController extends Controller {
  @Get()
  public async search(
    @Query() q: string,
    @Query() limit: number = 10,
    @Query() offset: number = 0
  ): Promise<{ results: any[] }> {
    // q is required
    // limit defaults to 10
    // offset defaults to 0

    return { results: [] };
  }
}
```

**Access**: `GET http://localhost:4000/express/search?q=test&limit=20`

### Example 4: Path Parameters

```typescript
@Route("orders")
@Tags("Orders")
export class OrdersController extends Controller {
  @Get("{orderId}/items/{itemId}")
  public async getOrderItem(
    @Path() orderId: string,
    @Path() itemId: string
  ): Promise<any> {
    return {
      orderId,
      itemId,
      // ... fetch from database
    };
  }
}
```

**Access**: `GET http://localhost:4000/express/orders/123/items/456`

### Example 5: Using MooseStack for ClickHouse Queries

```typescript
@Route("analytics")
@Tags("Analytics")
export class AnalyticsController extends Controller {
  @Get("customer-summary")
  public async getCustomerSummary(
    @Request() request: ExpressRequest,
    @Query() startDate?: string,
    @Query() endDate?: string
  ): Promise<any> {
    const moose = getMooseUtils(request);

    if (!moose) {
      this.setStatus(500);
      throw new Error("MooseStack utilities not available");
    }

    const { client, sql } = moose;

    // Build parameterized query
    const query = sql`
      SELECT
        COUNT(*) as total_customers,
        SUM(order_total) as total_revenue
      FROM customer_orders
      WHERE order_date >= ${startDate || '2024-01-01'}
        AND order_date <= ${endDate || '2024-12-31'}
    `;

    const result = await client.query.execute(query);
    const data = await result.json();

    return {
      success: true,
      summary: data[0],
    };
  }
}
```

**Access**: `GET http://localhost:4000/express/analytics/customer-summary?startDate=2024-01-01&endDate=2024-12-31`

---

## Summary

This Express + tsoa integration provides:

✅ **Type-safe APIs** with compile-time checking
✅ **Automatic validation** without manual schema writing
✅ **Auto-generated documentation** via OpenAPI/Swagger
✅ **Clean, maintainable code** using decorators
✅ **MooseStack integration** for ClickHouse and PostgreSQL access
✅ **Development-friendly** with hot reload and Swagger UI

For questions or issues, refer to the troubleshooting section or consult the tsoa documentation.
